{% extends 'admin/base.html' %}
{% block content %}

<!-- Properties Management Content -->
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
  <!-- Page Header -->
  <div class="flex justify-between items-center mb-8">
    <div>
      <h1 class="text-3xl font-bold text-gray-900 mb-2">Property Management</h1>
      <p class="text-gray-600">Manage all your real estate listings</p>
    </div>
    <button onclick="openAddModal()"
      class="bg-blue-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-blue-700 flex items-center gap-2">
      <i class="fas fa-plus"></i> Add New Property
    </button>
  </div>

  <!-- Filters & Search -->
  <div class="bg-white rounded-lg shadow-md p-6 mb-6">
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
      <div>
        <input type="text" placeholder="Search properties..."
          class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
      </div>
      <div>
        <select
          class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
          <option>All Status</option>
          <option>For Sale</option>
          <option>For Rent</option>
          <option>Sold</option>
          <option>Pending</option>
        </select>
      </div>
      <div>
        <select
          class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
          <option>All Types</option>
          <option>House</option>
          <option>Apartment</option>
          <option>Villa</option>
          <option>Condo</option>
        </select>
      </div>
      <div>
        <select
          class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
          <option>Sort by: Newest</option>
          <option>Sort by: Oldest</option>
          <option>Sort by: Price High</option>
          <option>Sort by: Price Low</option>
          <option>Sort by: Most Viewed</option>
        </select>
      </div>
    </div>
  </div>

  <!-- Properties Table -->
  <div class="bg-white rounded-lg shadow-md overflow-hidden">
    <div class="overflow-x-auto">
      <table class="w-full">
        <thead class="bg-gray-50 border-b">
          <tr>
            <th class="text-left py-4 px-6 text-sm font-semibold text-gray-700">
              <input type="checkbox" class="rounded">
            </th>
            <th class="text-left py-4 px-6 text-sm font-semibold text-gray-700">Property</th>
            <th class="text-left py-4 px-6 text-sm font-semibold text-gray-700">Type</th>
            <th class="text-left py-4 px-6 text-sm font-semibold text-gray-700">Status</th>
            <th class="text-left py-4 px-6 text-sm font-semibold text-gray-700">Price</th>
            <th class="text-left py-4 px-6 text-sm font-semibold text-gray-700">Location</th>
            <th class="text-left py-4 px-6 text-sm font-semibold text-gray-700">Views</th>
            <th class="text-left py-4 px-6 text-sm font-semibold text-gray-700">Date Added</th>
            <th class="text-left py-4 px-6 text-sm font-semibold text-gray-700">Actions</th>
          </tr>
        </thead>
        <tbody id="propertiesTable">


          {% for property in page_obj %}

          <tr class="border-b hover:bg-gray-50">
            <td class="py-4 px-6">
              <input type="checkbox" class="rounded">
            </td>
            <td class="py-4 px-6">
              <div class="flex items-center gap-3">
                <img src="	http://127.0.0.1:8000/media/property_images/main_image/studio_main2.png" alt="Property"
                  class="w-20 h-14 object-cover rounded">
                <div>
                  <p class="font-semibold text-gray-900">{{property.title}}</p>
                  <p class="text-xs text-gray-500">ID: #{{property.id}}</p>
                </div>
              </div>
            </td>
            <td class="py-4 px-6 text-gray-700">{{property.property_type}}</td>
            <td class="py-4 px-6 text-gray-700">{{property.status}}</td>
            <td class="py-4 px-6 font-semibold text-gray-900">{{property.price}}</td>
            <td class="py-4 px-6 text-gray-700">{{property.city}}, {{property.state}}</td>
            <td class="py-4 px-6 text-gray-700">4</td>
            <td class="py-4 px-6 text-gray-700">{{property.created_at}}</td>
            <td class="py-4 px-6">
              <div class="flex gap-2">

                <a class="text-blue-600 hover:text-blue-700 p-2" title="View"
                  href="http://127.0.0.1:8000/property/{{property.id}}">
                  <i class="fas fa-eye"></i>
                </a>

                <button onclick="editProperty({{property.id}})" class="text-green-600 hover:text-green-700 p-2"
                  title="Edit">
                  <i class="fas fa-edit"></i>
                </button>


                {%if property.is_active == False %}
                <button onclick="openApproveModal({{property.id}})" class="text-green-600 hover:text-green-700 p-2"
                  title="Approve">
                  <i class="fas fa-check"></i>
                </button>
                {%endif%}


              </div>
            </td>
          </tr>
          {% endfor %}


        </tbody>
      </table>
    </div>

    <!-- Pagination -->
    <div class="flex justify-between items-center px-6 py-4 border-t bg-gray-50">
      <p class="text-sm text-gray-600">
        Showing {{ page_obj.start_index }} to {{ page_obj.end_index }} of {{ page_obj.paginator.count }} properties
      </p>
      <div class="flex gap-2 items-center">
        {% if page_obj.has_previous %}
        <a href="?page={{ page_obj.previous_page_number }}"
          class="px-3 py-1 border border-gray-300 rounded hover:bg-gray-100">
          Previous
        </a>
        {% else %}
        <button class="px-3 py-1 border border-gray-300 rounded opacity-50 cursor-not-allowed" disabled>
          Previous
        </button>
        {% endif %}

        <span class="step-links flex gap-1">
          {% for num in page_obj.paginator.page_range %}
          {% if num == page_obj.number %}
          <span class="px-3 py-1 bg-blue-600 text-white rounded">{{ num }}</span>
          {% else %}
          <a href="?page={{ num }}" class="px-3 py-1 border border-gray-300 rounded hover:bg-gray-100">{{ num }}</a>
          {% endif %}
          {% endfor %}
        </span>

        {% if page_obj.has_next %}
        <a href="?page={{ page_obj.next_page_number }}"
          class="px-3 py-1 border border-gray-300 rounded hover:bg-gray-100">
          Next
        </a>
        {% else %}
        <button class="px-3 py-1 border border-gray-300 rounded opacity-50 cursor-not-allowed" disabled>
          Next
        </button>
        {% endif %}
      </div>
    </div>
  </div>
</div>





<!-- Add Property Modal -->
<div id="addModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
  <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
    <div class="sticky top-0 bg-white border-b px-6 py-4 flex justify-between items-center">
      <h2 class="text-2xl font-bold text-gray-900">Add New Property</h2>
      <button onclick="closeAddModal()" class="text-gray-600 hover:text-gray-900">
        <i class="fas fa-times text-xl"></i>
      </button>
    </div>

    <form class="p-6 space-y-4">
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Property Title</label>
          <input type="text" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
            placeholder="Modern Family Villa" required>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Property Type</label>
          <select class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" required>
            <option>House</option>
            <option>Apartment</option>
            <option>Villa</option>
            <option>Condo</option>
            <option>Penthouse</option>
          </select>
        </div>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Status</label>
          <select class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" required>
            <option>For Sale</option>
            <option>For Rent</option>
            <option>Pending</option>
            <option>Sold</option>
          </select>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Price</label>
          <input type="text" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
            placeholder="$1,250,000" required>
        </div>
      </div>

      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">Address</label>
        <input type="text" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
          placeholder="123 Luxury Lane, Beverly Hills, CA 90210" required>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Bedrooms</label>
          <input type="number"
            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="4"
            required>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Bathrooms</label>
          <input type="number"
            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="3"
            required>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Square Feet</label>
          <input type="number"
            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
            placeholder="3200" required>
        </div>
      </div>

      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">Description</label>
        <textarea rows="4" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
          placeholder="Enter property description..." required></textarea>
      </div>

      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">Property Images</label>
        <div
          class="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center hover:border-blue-500 cursor-pointer">
          <i class="fas fa-cloud-upload-alt text-4xl text-gray-400 mb-2"></i>
          <p class="text-gray-600">Click to upload or drag and drop</p>
          <p class="text-sm text-gray-500 mt-1">PNG, JPG up to 10MB</p>
        </div>
      </div>

      <div class="flex gap-4 pt-4">
        <button type="submit" class="flex-1 bg-blue-600 text-white py-3 rounded-lg font-semibold hover:bg-blue-700">
          Add Property
        </button>
        <button type="button" onclick="closeAddModal()"
          class="px-6 py-3 border border-gray-300 rounded-lg font-semibold hover:bg-gray-50">
          Cancel
        </button>
      </div>
    </form>
  </div>
</div>

<!-- Edit Property Modal -->
<div id="editModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
  <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
    <div class="sticky top-0 bg-white border-b px-6 py-4 flex justify-between items-center">
      <h2 class="text-2xl font-bold text-gray-900">Edit Property</h2>
      <button onclick="closeEditModal()" class="text-gray-600 hover:text-gray-900">
        <i class="fas fa-times text-xl"></i>
      </button>
    </div>

    <form class="p-6 space-y-4" onsubmit="saveProperty(event)">
      <input type="hidden" id="edit_propertyId">

      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Property Title</label>
          <input type="text" id="edit_title"
            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" required>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Property Type</label>
          <select id="edit_type"
            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" required>
            <option>House</option>
            <option>Apartment</option>
            <option>Villa</option>
            <option>Condo</option>
            <option>Penthouse</option>
          </select>
        </div>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Status</label>
          <select id="edit_status"
            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" required>
            <option>For Sale</option>
            <option>For Rent</option>
            <option>Pending</option>
            <option>Sold</option>
          </select>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Price</label>
          <input type="text" id="edit_price"
            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" required>
        </div>
      </div>

      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">Location</label>
        <input type="text" id="edit_location"
          class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" required>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Bedrooms</label>
          <input type="number" id="edit_bedrooms"
            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" required>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Bathrooms</label>
          <input type="number" id="edit_bathrooms"
            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" required>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Square Feet</label>
          <input type="number" id="edit_sqft"
            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" required>
        </div>
      </div>

      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">Description</label>
        <textarea rows="4" id="edit_description"
          class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
          placeholder="Enter property description..."></textarea>
      </div>

      <div class="flex justify-end gap-3 pt-4 border-t">
        <button type="button" onclick="closeEditModal()"
          class="px-6 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 font-medium">
          Cancel
        </button>
        <button type="submit" class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-semibold">
          Save Changes
        </button>
      </div>
    </form>
  </div>
</div>


<div id="approveModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
  <div class="bg-white rounded-lg shadow-xl max-w-md w-full">
    <div class="p-6 border-b flex items-center gap-3">
      <div class="w-10 h-10 rounded-full bg-green-100 flex items-center justify-center">
        <i class="fas fa-check text-green-600 text-xl"></i>
      </div>
      <h3 class="text-xl font-bold text-gray-900">Approve Property?</h3>
    </div>

    <div class="p-6">
      <p class="text-gray-600">
        Are you sure you want to approve this property? It will become visible on the public site immediately.
      </p>
    </div>

    <div class="p-4 bg-gray-50 rounded-b-lg flex justify-end gap-3">
      <button onclick="closeApproveModal()"
        class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-100 font-medium">
        Cancel
      </button>
      <button onclick="confirmApprove()"
        class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 font-semibold shadow-sm">
        Yes, Approve It
      </button>
    </div>
  </div>
</div>





<script>
  let propertyIdToApprove = null;

  function openApproveModal(id) {
    propertyIdToApprove = id;
    document.getElementById('approveModal').classList.remove('hidden');
  }

  function closeApproveModal() {
    document.getElementById('approveModal').classList.add('hidden');
    propertyIdToApprove = null;
  }

  function confirmApprove() {
    if (!propertyIdToApprove) {
      alert('No property selected');
      return;
    }

    fetch(`/api/approve_property/${propertyIdToApprove}`, {
      method: 'POST',
      headers: {
        'X-CSRFToken': '{{ csrf_token }}'
      },
    })
      .then(response => {
        if (response.ok) {
          alert('Property approved successfully!');
          closeApproveModal();
          location.reload();
        } else {
          alert('Failed to approve property');
        }
      })
      .catch(error => {
        console.error('Error:', error);
        alert('An error occurred while approving property');
      });
  }

  function viewProperty(id) {
    window.open(`../property-detail.html?id=${id}`, '_blank');
  }

  function editProperty(id) {
    fetch(`/api/property_api_get_by_id/${id}`)
      .then(response => response.json())
      .then(data => {

        document.getElementById('edit_propertyId').value = data.id;
        document.getElementById('edit_title').value = data.title;
        document.getElementById('edit_type').value = data.property_type;
        document.getElementById('edit_status').value = data.status;
        document.getElementById('edit_price').value = data.price;
        document.getElementById('edit_location').value = data.address;
        document.getElementById('edit_bedrooms').value = data.bedrooms;
        document.getElementById('edit_bathrooms').value = data.bathrooms;
        document.getElementById('edit_sqft').value = data.square_feet;
        document.getElementById('edit_description').value = data.description;
        document.getElementById('editModal').classList.remove('hidden');

      })
      .catch(error => {
        console.error('Error fetching property details:', error);
        alert('Failed to load property details.');
      });
  }

  function closeEditModal() {
    document.getElementById('editModal').classList.add('hidden');
  }

  function saveProperty(event) {
    event.preventDefault();
    const id = document.getElementById('edit_propertyId').value;
    const data = {
      title: document.getElementById('edit_title').value,
      property_type: document.getElementById('edit_type').value,
      status: document.getElementById('edit_status').value,
      price: document.getElementById('edit_price').value,
      address: document.getElementById('edit_location').value,
      bedrooms: document.getElementById('edit_bedrooms').value,
      bathrooms: document.getElementById('edit_bathrooms').value,
      square_feet: document.getElementById('edit_sqft').value,
      description: document.getElementById('edit_description').value
    };


    fetch(`/api/update_property/${id}`, {
      method: 'PUT',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': '{{ csrf_token }}' // Ensure csrf_token is available in context
      },
      body: JSON.stringify(data)
    })
      .then(response => {
        if (response.ok) return response.json();
        throw new Error('Failed to update property');
      })
      .then(result => {
        alert('Property updated successfully!');
        closeEditModal();
        location.reload();
      })
      .catch(error => {
        console.error('Error updating property:', error);
        alert('An error occurred while updating the property.');
      });
  }

</script>

{% endblock %}